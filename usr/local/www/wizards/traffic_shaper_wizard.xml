<?xml version="1.0" encoding="utf-8" ?>
<pfsensewizard>
<copyright>
/* $Id$ */
/*
	traffic_shaper_wizard.xml
        part of pfSense (http://www.pfsense.org/)

        Copyright (C) 2005 Bill Marquette - bill.marquette@gmail.com.
        All rights reserved.

        Redistribution and use in source and binary forms, with or without
        modification, are permitted provided that the following conditions are met:

        1. Redistributions of source code must retain the above copyright notice,
           this list of conditions and the following disclaimer.

        2. Redistributions in binary form must reproduce the above copyright
           notice, this list of conditions and the following disclaimer in the
           documentation and/or other materials provided with the distribution.

        THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,
        INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
        AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
        AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
        OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
        SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
        INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
        CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
        ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
        POSSIBILITY OF SUCH DAMAGE.
*/
</copyright>
<totalsteps>8</totalsteps>
<step>
	<id>1</id>
	<title>pfSense Traffic Shaper Wizard</title>
	<disableheader>true</disableheader>
	<description>This wizard will guide you through setting up the pfSense traffic shaper.</description>
	<fields>
		<field>
			<name>Next</name>
			<type>submit</type>
			<warning>Going any further will wipe your existing shaper config!  If you do not wish to continue, please click the pfSense logo at the top to return to the webConfigurator.</warning>
		</field>
	</fields>
	<stepbeforeformdisplay>
		/* Check to see if ALTQ can even be used */
		if(!is_altq_capable($config['interfaces']['wan']['if']) or !is_altq_capable($config['interfaces']['lan']['if'])) {
			$message="Either your LAN or WAN interface doesn't support ALTQ.  The wizard cannot continue.";
			header("Location: /wizard.php?xml=traffic_shaper_wizard.xml&amp;stepid=7&amp;message={$message}");
		}
	</stepbeforeformdisplay>
	<stepsubmitphpaction>
		/* wipe previous */
		unset($config['shaper']['queue']);
		unset($config['shaper']['rule']);
		$config['shaper']['enable'] = FALSE;
		$config['shaper']['itemsshaped'] = "0";
	</stepsubmitphpaction>
</step>
<step>
	<id>2</id>
	<title>pfSense Traffic Shaper Wizard</title>
	<description>Shaper configuration</description>
        <javascriptafterformdisplay>
        </javascriptafterformdisplay>
	<fields>
                <field>
                        <name>Setup network speeds</name>
                        <type>listtopic</type>
                </field>
		<field>
			<name>Inside</name>
			<description>Inside interface for shaping your download speeds</description>
			<type>interfaces_selection</type>
                        <typehint>This is usually the LAN interface</typehint>
			<bindstofield>ezshaper->step2->inside_int</bindstofield>
		</field>
                <field>
                        <name>Download</name>
                        <description>The download speed of your WAN link in Kbits/second. Note: PPPOE users should take into account PPPOE overhead and put a lower speed here.</description>
                        <type>input</type>
			<validate>^[0-9]*$</validate>
			<message>Download speed must be numerical</message>
			<bindstofield>ezshaper->step2->download</bindstofield>
                </field>
		<field>
			<name>Outside</name>
			<description>Outside interface for shaping your upload speeds</description>
			<type>interfaces_selection</type>
                        <typehint>This is usually the WAN interface</typehint>
			<bindstofield>ezshaper->step2->outside_int</bindstofield>
		</field>
                <field>
                        <name>Upload</name>
                        <description>The upload speed of your WAN link in Kbits/second. Note: PPPOE users should take into account PPPOE overhead and put a lower speed here.</description>
                        <type>input</type>
			<validate>^[0-9]*$</validate>
			<message>Upload speed must be numerical</message>
			<bindstofield>ezshaper->step2->upload</bindstofield>
                </field>
		<field>
			<name>Next</name>
			<type>submit</type>
		</field>
	</fields>
	<stepsubmitphpaction>
		if ($config['ezshaper']['step2']['inside_int'] == $config['ezshaper']['step2']['outside_int']) {
			$message="Inside and Outside interfaces cannot be the same";
			header("Location: /wizard.php?xml=traffic_shaper_wizard.xml&amp;stepid={$stepid}&amp;message={$message}");
			exit;
		}
		$downq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['inside_int']);
		$upq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['outside_int']);
	    
		/* Magic shaper scheduler */
		$config['shaper']['schedulertype'] = "hfsc";

		/* Create queues */
		/* WAN root queue */
		$queue = array();
		$queue['name'] = "{$upq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 0;
		$queue['parentqueue'] = "on";
		/* $queue['bandwidth'] = (int)$_POST['upload'] * .8; */
		$queue['bandwidth'] = (int)$_POST['upload'];
		$queue['bandwidthtype'] = "Kb";
		$config['shaper']['queue'][] = $queue;

		/* LAN root queue */
		$queue = array();
		$queue['name'] = "{$downq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 0;
		$queue['parentqueue'] = "on";
		/* $queue['bandwidth'] = (int)$_POST['download'] * .8; */
		$queue['bandwidth'] = (int)$_POST['download'];
		$queue['bandwidthtype'] = "Kb";
		$config['shaper']['queue'][] = $queue;

		/* WAN default queue */
                $queue = array();
                $queue['name'] = "{$upq}def";
                $queue['attachtoqueue'] = "{$upq}Root";
                $queue['associatedrule'] = 0;
		$queue['defaultqueue'] = 'true';
                $queue['priority'] = 3;
		if ($config['shaper']['schedulertype'] == "hfsc") {
                	$queue['realtime'] = "on";
                	$queue['realtime3'] = "1%";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
			$queue['bandwidth'] = 6;
			$queue['bandwidthtype'] = 'Kb';
		}
                $config['shaper']['queue'][] = $queue;


		/* LAN default queue */
                $queue = array();
                $queue['name'] = "{$downq}def";
                $queue['priority'] = 3;
                $queue['attachtoqueue'] = "{$downq}Root";
                $queue['associatedrule'] = 0;
		$queue['defaultqueue'] = 'true';
		if ($config['shaper']['schedulertype'] == "hfsc") {
                	$queue['realtime'] = "on";
                	$queue['realtime3'] = "1%";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
			$queue['bandwidth'] = 6;
			$queue['bandwidthtype'] = 'Kb';
		}
                $config['shaper']['queue'][] = $queue;

		/* WAN ack queue */
                $queue = array();
                $queue['name'] = "{$upq}acks";
		$queue['ack'] = TRUE;
                $queue['attachtoqueue'] = "{$upq}Root";
                $queue['associatedrule'] = 0;
                $queue['priority'] = 7;
		if ($config['shaper']['schedulertype'] == "hfsc") {
                	$queue['realtime'] = "on";
                	$queue['realtime3'] = "10%";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
			$queue['bandwidth'] = 6;
			$queue['bandwidthtype'] = 'Kb';
		}
                $config['shaper']['queue'][] = $queue;
                $queue = array();

		/* LAN ack queue */
                $queue['name'] = "{$downq}acks";
		$queue['ack'] = TRUE;
                $queue['attachtoqueue'] = "{$downq}Root";
                $queue['associatedrule'] = 0;
                $queue['priority'] = 7;
		if ($config['shaper']['schedulertype'] == "hfsc") {
                	$queue['realtime'] = "on";
                	$queue['realtime3'] = "10%";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
			$queue['bandwidth'] = 6;
			$queue['bandwidthtype'] = 'Kb';
		}
                $config['shaper']['queue'][] = $queue;

		
	</stepsubmitphpaction>
</step>
<step>
        <id>3</id>
        <title>pfSense Traffic Shaper Wizard</title>
        <description>Voice over IP</description>
        <fields>
                <field>
                        <name>Enable</name>
                        <type>checkbox</type>
			<typehint>Prioritize Voice over IP traffic</typehint>
                        <description>This will raise the priority of VOIP traffic above all other traffic.</description>
			<bindstofield>ezshaper->step3->enable</bindstofield>
                </field>
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
                <field>
                        <name>VOIP specific settings</name>
                        <type>listtopic</type>
                </field>
                <field>
                        <name>Provider</name>
                        <type>select</type>
			<description>Choose Generic if your provider isn't listed.</description>
			<bindstofield>ezshaper->step3->provider</bindstofield>
                        <options>
                                <option>
                                        <name>Generic (lowdelay)</name>
                                        <value>Generic</value>
                                </option>
                                <option>
                                        <name>VoicePulse</name>
                                        <value>VoicePulse</value>
                                </option>
                                <option>
                                        <name>Vonage</name>
                                        <value>Vonage</value>
                                </option>
                                <option>
                                        <name>Asterisk</name>
                                        <value>Asterisk</value>
				</option>			
                                <option>
                                        <name>PanasonicTDA</name>
                                        <value>Panasonic</value>
				</option>
			</options>
		</field>
		<field>
                        <name>Address</name>
			<type>inputalias</type>
			<description>(Optional) If this is chosen, the provider field will be overridden.  This allows you to just provide the IP address of the VOIP adaptor to prioritize.  NOTE: You can also use a Firewall Alias in this location.</description>
			<bindstofield>ezshaper->step3->address</bindstofield>
			<message>IP Address field is non-blank and doesn't look like an IP address.</message>
		</field>
		<field>
                        <name>Bandwidth</name>
                        <type>select</type>
			<typehint>Total bandwidth guarantee for VOIP phone(s)</typehint>
			<default>128</default>
			<bindstofield>ezshaper->step3->bandwidth</bindstofield>
			<options>
                                <option>
                                        <name>32Kbits/sec</name>
                                        <value>32</value>
                                </option>
                                <option>
                                        <name>64Kbits/sec</name>
                                        <value>64</value>
                                </option>
                                <option>
                                        <name>96Kbits/sec</name>
                                        <value>96</value>
                                </option>
                                <option>
                                        <name>128Kbits/sec</name>
                                        <value>128</value>
                                </option>
                                <option>
                                        <name>256Kbits/sec</name>
                                        <value>256</value>
                                </option>
                                <option>
                                        <name>384Kbits/sec</name>
                                        <value>384</value>
                                </option>
                                <option>
                                        <name>512Kbits/sec</name>
                                        <value>512</value>
                                </option>
                                <option>
                                        <name>768Kbits/sec</name>
                                        <value>768</value>
                                </option>
                                <option>
                                        <name>1024Kbits/sec</name>
                                        <value>1024</value>
                                </option>
                                <option>
                                        <name>1500Kbits/sec</name>
                                        <value>1500</value>
                                </option>
                                <option>
                                        <name>3000Kbits/sec</name>
                                        <value>3000</value>
                                </option>
                                <option>
                                        <name>4000Kbits/sec</name>
                                        <value>4000</value>
                                </option>
                                <option>
                                        <name>5000Kbits/sec</name>
                                        <value>5000</value>
                                </option>
                                <option>
                                        <name>6000Kbits/sec</name>
                                        <value>6000</value>
                                </option>
                                <option>
                                        <name>7000Kbits/sec</name>
                                        <value>7000</value>
                                </option>
                                <option>
                                        <name>8000Kbits/sec</name>
                                        <value>8000</value>
                                </option>
                                <option>
                                        <name>9000Kbits/sec</name>
                                        <value>9000</value>
                                </option>
                                <option>
                                        <name>10000Kbits/sec</name>
                                        <value>10000</value>
                                </option>
                                <option>
                                        <name>11000Kbits/sec</name>
                                        <value>11000</value>
                                </option>
                                <option>
                                        <name>12000Kbits/sec</name>
                                        <value>12000</value>
                                </option>
			</options>
		</field>
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
        </fields>
	<stepsubmitphpaction>
		if($_POST['address']) {
			if(!is_ipaddr($_POST['address'])) {
				if(!is_alias($_POST['address'])) {
					/* item is not an ip or alias.  error out */
					$message="Address must be a valid IP address or Firewall Alias.  Please correct this value to continue.";
					header("Location: /wizard.php?xml=traffic_shaper_wizard.xml&amp;stepid=3&amp;message={$message}");
					exit;
				}
			}
		}

		if ( $_POST['enable'] ) {
			$downq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['inside_int']);
			$upq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['outside_int']);
			$downint = strtolower($config['ezshaper']['step2']['inside_int']);
			$upint = strtolower($config['ezshaper']['step2']['outside_int']);

	                /* create qVOIPUp */
	                $queue = array();
	                $queue['name'] = "qVOIPUp";
 	               	$queue['attachtoqueue'] = "{$upq}Root";
	                $queue['associatedrule'] = 0;
	                $queue['priority'] = 7;
			if ($config['shaper']['schedulertype'] == "hfsc") {
				$queue['realtime'] = "on";
	                	$queue['realtime3'] = $_POST['bandwidth'] . "Kb";
				$queue['bandwidth'] = 1;
				$queue['bandwidthtype'] = '%';
			} elseif ($config['shaper']['schedulertype'] == "cbq") {
                        	$queue['bandwidth'] = $_POST['bandwidth'];
                        	$queue['bandwidthtype'] = 'Kb';
			}
 	                $config['shaper']['queue'][] = $queue;

 	                /* create qVOIPDown */
 	                $queue = array();
 	                $queue['name'] = "qVOIPDown";
 	                $queue['attachtoqueue'] = "{$downq}Root";
 	                $queue['associatedrule'] = 0;
 	                $queue['priority'] = 7;
			if ($config['shaper']['schedulertype'] == "hfsc") {
 	                	$queue['realtime'] = "on";
 	                	$queue['realtime3'] = $_POST['bandwidth'] . "Kb";
				$queue['bandwidth'] = 1;
				$queue['bandwidthtype'] = '%';
			} elseif ($config['shaper']['schedulertype'] == "cbq") {
                        	$queue['bandwidth'] = $_POST['bandwidth'];
                        	$queue['bandwidthtype'] = 'Kb';
			}
 	                $config['shaper']['queue'][] = $queue;			

			$config['shaper']['itemsshaped']++;

			/* If user specifies an IP, we don't bother with providers */
			if( is_ipaddr($_POST['address']) ) {
			    /* create VOIP rules */
			    $rule = array();
			    $rule['descr'] = "VOIP Adapter";
			    $rule['inqueue'] = "qVOIPDown";
			    $rule['outqueue'] = "qVOIPUp";
			    $rule['in-interface'] = $downint;
			    $rule['out-interface'] = $upint;
			    /* $rule['source']['network'] = $downint; */
			    $rule['source']['address'] = $_POST['address'];
			    $rule['destination']['any'] = TRUE;
			    $config['shaper']['rule'][] = $rule;

			    $rule = array();
			    $rule['descr'] = "VOIP Adapter";
			    $rule['inqueue'] = "qVOIPUp";
			    $rule['outqueue'] = "qVOIPDown";
			    $rule['in-interface'] = $upint;
			    $rule['out-interface'] = $downint;
			    $rule['source']['any'] = TRUE;
			    $rule['destination']['address'] = $_POST['address'];
			    $config['shaper']['rule'][] = $rule;
			} elseif( $_POST['provider'] == "Generic" ) {
			    /* create VOIP rules */
			    $rule = array();
			    $rule['descr'] = "DiffServ/Lowdelay/Upload";
			    $rule['inqueue'] = "qVOIPDown";
			    $rule['outqueue'] = "qVOIPUp";
			    $rule['in-interface'] = $downint;
			    $rule['out-interface'] = $upint;
			    $rule['source']['network'] = $downint;
			    $rule['destination']['any'] = TRUE;
			    $rule['iptos'] = "lowdelay";
			    $config['shaper']['rule'][] = $rule;

			    $rule = array();
			    $rule['descr'] = "DiffServ/Lowdelay/Download";
			    $rule['inqueue'] = "qVOIPUp";
			    $rule['outqueue'] = "qVOIPDown";
			    $rule['in-interface'] = $upint;
			    $rule['out-interface'] = $downint;
			    $rule['source']['any'] = TRUE;
			    $rule['destination']['network'] = $downint;
			    $rule['iptos'] = "lowdelay";
			    $config['shaper']['rule'][] = $rule;
			} else {
			
			    $voiplist = array();
	    
			    /* asterisk server / same as vonage */
			    if(($_POST['provider'] == "Asterisk") || ($_POST['provider'] == "Vonage")) {
				$voiplist[] = array('Asterisk', 'udp', '5060', '5069', 'both');
				$voiplist[] = array('Asterisk', 'udp', '10000', '20000', 'both');
			    }

			    /* VoicePulse server */
			    if( $_POST['provider'] == "VoicePulse") {
				$voiplist[] = array('VoicePulse', 'udp', '16384', '16482', 'both');
				$voiplist[] = array('VoicePulse', 'udp', '4569', '4569', 'both');
			    }

			    /* Panasonic Hybrid PBX */
			    if( $_POST['provider'] == "Panasonic") {
				$voiplist[] = array('Panasonic1', 'udp', '8000', '8063', 'both');
				$voiplist[] = array('Panasonic2', 'udp', '9300', '9301', 'both');
				$voiplist[] = array('Panasonic3', 'udp', '2747', '2747', 'both');
			    }

			    /* Set up/down VOIP as higher weight */
			    /* loop through voiplist[] */
			    foreach ($voiplist as $voip) {
				foreach (array('source', 'destination') as $srcdest) {
					$rule = array();
					if ($srcdest == 'source') {
						$destsrc = 'destination';
						$rule['inqueue'] = 'qVOIPDown';
						$rule['outqueue'] = 'qVOIPUp';
						$rule['in-interface'] = $downint;
						$rule['out-interface'] = $upint;
						$rule['source']['network'] = $downint;
						$rule['destination']['any'] = TRUE;
						$rule['descr'] = "m_voip {$voip[0]} outbound";
					} else {
						$destsrc = 'source';
						$rule['inqueue'] = 'qVOIPUp';
						$rule['outqueue'] = 'qVOIPDown';
						$rule['in-interface'] = $upint;
						$rule['out-interface'] = $downint;
						$rule['source']['any'] = TRUE;
						$rule['destination']['network'] = $downint;
						$rule['descr'] = "m_voip {$voip[0]} inbound";
					}
				    
					$rule['destination']['port'] = $voip[2]."-".$voip[3];
					if($voip[1] != '')
						$rule['protocol'] = $voip[1];
		
					$config['shaper']['rule'][] = $rule;
				}
			    }                
			}
		}
                
	</stepsubmitphpaction>
</step>
<step>
        <id>4</id>
        <title>pfSense Traffic Shaper Wizard</title>
        <description>Peer to Peer networking</description>
	<disableallfieldsbydefault>true</disableallfieldsbydefault>
        <fields>
            <field>
				<donotdisable>true</donotdisable>
                <name>Enable</name>
                <type>checkbox</type>
                <typehint>Lower priority of Peer-to-Peer traffic</typehint>
                <description>This will lower the priority of P2P traffic below all other traffic.  Please check the items that you would like to prioritize lower than normal traffic.</description>
				<enablefields>Aimster,BitTorrent,BuddyShare,CuteMX,DCplusplus,dcc,DirectConnect,DirectFileExpress,EDonkey2000,FastTrack,Gnutella,grouper,hotComm,HotlineConnect,iMesh,Napster,OpenNap,Scour,Shareaza,SongSpy,WinMX</enablefields>
				<bindstofield>ezshaper->step4->enable</bindstofield>
            </field>
            <field>
                    <name>Next</name>
                    <type>submit</type>
            </field>
			<field>
					<name>p2p Catch all</name>
					<type>listtopic</type>
			</field>
			<field>
				<donotdisable>true</donotdisable>
				<name>p2pCatchAll</name>
				<type>checkbox</type>
				<typehint>When enabled, all uncategorized traffic is fed to the p2p queue.</typehint>
				<bindstofield>ezshaper->step4->p2pcatchall</bindstofield>
			</field>
			<field>
					<name>Enable/Disable specific P2P protocols</name>
					<type>listtopic</type>
			</field>			
            <field>
                <name>Aimster</name>
                <type>checkbox</type>
				<typehint>Aimster and other P2P using the Aimster protocol and ports</typehint>
				<bindstofield>ezshaper->step4->aimster</bindstofield>
            </field>
            <field>
				<name>BitTorrent</name>
                <type>checkbox</type>
				<typehint>Bittorrent and other P2P using the Torrent protocol and ports</typehint>
				<bindstofield>ezshaper->step4->bittorrent</bindstofield>
            </field>
            <field>
                <name>BuddyShare</name>
                <type>checkbox</type>
				<typehint>BuddyShare and other P2P using the BuddyShare protocol and ports</typehint>
				<bindstofield>ezshaper->step4->buddyshare</bindstofield>
            </field>
            <field>
                <name>CuteMX</name>
                <type>checkbox</type>
				<typehint>CuteMX and other P2P using the CuteMX protocol and ports</typehint>
				<bindstofield>ezshaper->step4->cutemx</bindstofield>
            </field>
            <field>
                <name>DCplusplus</name>
                <type>checkbox</type>
				<typehint>DC++ and other P2P using the DC++ protocol and ports</typehint>
				<bindstofield>ezshaper->step4->dcplusplus</bindstofield>
            </field>
            <field>
                <name>DCC</name>
                <type>checkbox</type>
				<typehint>irc DCC file transfers</typehint>
				<bindstofield>ezshaper->step4->dcc</bindstofield>
            </field>
            <field>
                <name>DirectConnect</name>
                <type>checkbox</type>
				<typehint>DirectConnect and other P2P using the DirectConnect protocol and ports</typehint>
				<bindstofield>ezshaper->step4->directconnect</bindstofield>
            </field>
            <field>
                    <name>DirectFileExpress</name>
                    <type>checkbox</type>
					<typehint>DirectFileExpress and other P2P using the DirectFileExpress protocol and ports</typehint>
					<bindstofield>ezshaper->step4->directfileexpress</bindstofield>
            </field>
            <field>
                    <name>eDonkey2000</name>
                    <type>checkbox</type>
				<typehint>eDonkey and other P2P using the eDonkey protocol and ports</typehint>
				<bindstofield>ezshaper->step4->edonkey2000</bindstofield>
            </field>
            <field>
                <name>FastTrack</name>
                <type>checkbox</type>
				<typehint>FastTrack and other P2P using the FastTrack protocol and ports</typehint>
				<bindstofield>ezshaper->step4->fasttrack</bindstofield>
            </field>
            <field>
                        <name>Gnutella</name>
                        <type>checkbox</type>
				<typehint>Gnutella and other P2P using the Gnutella protocol and ports</typehint>
				<bindstofield>ezshaper->step4->gnutella</bindstofield>
            </field>
           <field>
                <name>grouper</name>
                <type>checkbox</type>
				<typehint>grouper and other P2P using the grouper protocol and ports</typehint>
				<bindstofield>ezshaper->step4->grouper</bindstofield>
			</field>
			<field>
				<name>hotComm</name>
				<type>checkbox</type>
				<typehint>hotComm and other P2P using the hotComm protocol and ports</typehint>
				<bindstofield>ezshaper->step4->hotcomm</bindstofield>
            </field>
            <field>
                <name>HotlineConnect</name>
                <type>checkbox</type>
				<typehint>HotlineConnect and other P2P using the HotlineConnect protocol and ports</typehint>
				<bindstofield>ezshaper->step4->hotlineconnect</bindstofield>
            </field>
            <field>
                <name>iMesh</name>
                <type>checkbox</type>
				<typehint>iMesh and other P2P using the iMesh protocol and ports</typehint>
				<bindstofield>ezshaper->step4->imesh</bindstofield>
            </field>
            <field>
                <name>Napster</name>
                <type>checkbox</type>
				<typehint>Napster and other P2P using the Napster protocol and ports</typehint>
				<bindstofield>ezshaper->step4->napster</bindstofield>
            </field>
            <field>
                <name>OpenNap</name>
                <type>checkbox</type>
				<typehint>OpenNap and other P2P using the OpenNap protocol and ports</typehint>
				<bindstofield>ezshaper->step4->opennap</bindstofield>
            </field>
            <field>
                <name>Scour</name>
		        <type>checkbox</type>
				<typehint>Scour and other P2P using the Scour protocol and ports</typehint>
				<bindstofield>ezshaper->step4->scour</bindstofield>
            </field>
            <field>
                <name>Shareaza</name>
                <type>checkbox</type>
				<typehint>Shareaza and other P2P using the Shareaza protocol and ports</typehint>
				<bindstofield>ezshaper->step4->shareaza</bindstofield>
            </field>
            <field>
                <name>SongSpy</name>
                <type>checkbox</type>
				<typehint>SongSpy and other P2P using the SongSpy protocol and ports</typehint>
				<bindstofield>ezshaper->step4->songspy</bindstofield>
            </field>
            <field>
                <name>WinMX</name>
                <type>checkbox</type>
				<typehint>WinMX and other P2P using the WinMX protocol and ports</typehint>
				<bindstofield>ezshaper->step4->winmx</bindstofield>
            </field>
            <field>
                <name>Next</name>
                <type>submit</type>
            </field>
        </fields>
	<stepsubmitphpaction>

	/* XXX - billm - needs to actually honor what the user selects still */
	if ( $_POST['enable'] ) {
		$downq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['inside_int']);
		$upq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['outside_int']);
		$downint = strtolower($config['ezshaper']['step2']['inside_int']);
		$upint = strtolower($config['ezshaper']['step2']['outside_int']);

		$p2plist = array();

		/* To add p2p clients, push Descr,Protocol,Start,End,src/dest/both onto p2plist */
		if($_POST['aimster'] != "") 
		    $p2plist[] = array('Aimster', 'tcp', '7668', '7668', 'both');
		if($_POST['bittorrent'] != "") 		    
		    $p2plist[] = array('BitTorrent', 'tcp', '6881', '6999', 'both');
		if($_POST['buddyshare'] != "") 		
		    $p2plist[] = array('BuddyShare', 'tcp', '7788', '7788', 'both');
		if($_POST['cutemx'] != "") 		
		    $p2plist[] = array('CuteMX', 'tcp', '2340', '2340', 'both');
		if($_POST['dc++'] != "") 		
		    $p2plist[] = array('DC++', 'tcp', '1412', '1412', 'both');
		if($_POST['dcc'] != "") 		
		    $p2plist[] = array('dcc', 'tcp', '6666', '6668', 'both');
		if($_POST['directconnect'] != "") 		
		    $p2plist[] = array('DirectConnect', 'tcp', '412', '412', 'both');
		if($_POST['directfileexpress'] != "") 		
		    $p2plist[] = array('DirectFileExpress', 'tcp', '1044', '1045', 'both');
		if($_POST['edonkey2000'] != "") 		
		    $p2plist[] = array('EDonkey2000', 'tcp', '4661', '4665', 'both');
		if($_POST['fastTrack'] != "") 		
		    $p2plist[] = array('FastTrack', 'tcp', '1214', '1214', 'both');
		if($_POST['gnutella'] != "") { 		
		    $p2plist[] = array('Gnutella-TCP', 'tcp', '6346', '6346', 'both');
		    $p2plist[] = array('Gnutella-UDP', 'udp', '6346', '6346', 'both');
		}
		if($_POST['grouper'] != "") 		
		    $p2plist[] = array('grouper', 'tcp', '8038', '8039', 'both');
		if($_POST['hotcomm'] != "") 		
		    $p2plist[] = array('hotComm', 'tcp', '28864', '28865', 'both');
		if($_POST['hotlineconnect'] != "") 		
		    $p2plist[] = array('HotlineConnect', 'tcp', '5500', '5503', 'both');
		if($_POST['imesh'] != "") 		
		    $p2plist[] = array('iMesh', 'tcp', '4329', '4329', 'both');
		if($_POST['napster'] != "") 		
		    $p2plist[] = array('Napster', 'tcp', '6699', '6701', 'both');
		if($_POST['opennap'] != "") 		
		    $p2plist[] = array('OpenNap', 'tcp', '8888', '8889', 'both');
		if($_POST['scour'] != "") 		
		    $p2plist[] = array('Scour', 'tcp', '8311', '8311', 'both');
		if($_POST['shareaza'] != "") 		
		    $p2plist[] = array('Shareaza', 'tcp', '6346', '6346', 'both');
		if($_POST['songspy'] != "") 		
		    $p2plist[] = array('SongSpy', 'tcp', '5190', '5190', 'both');
		if($_POST['winmx'] != "") 		
		    $p2plist[] = array('WinMX', 'tcp', '6699', '6699', 'both');

		/* Set up/down p2p as lowest weight */
		/* loop through p2plist[] */
		foreach ($p2plist as $p2pclient) {
			foreach (array('source', 'destination') as $srcdest) {
				$rule = array();
				$config['shaper']['itemsshaped']++;
				if ($srcdest == 'source') {
					$destsrc = 'destination';
					$rule['inqueue'] = 'qP2PDown';
					$rule['outqueue'] = 'qP2PUp';
					$rule['in-interface'] = $downint;
					$rule['out-interface'] = $upint;
					$rule['interface'] = $downint;
					$rule['source']['network'] = $downint;
					$rule['destination']['any'] = TRUE;
					$rule['descr'] = "m_P2P {$p2pclient[0]} outbound";
				} else {
					$destsrc = 'source';
					$rule['inqueue'] = 'qP2PUp';
					$rule['outqueue'] = 'qP2PDown';
					$rule['in-interface'] = $upint;
					$rule['out-interface'] = $downint;
					$rule['source']['any'] = TRUE;
					$rule['destination']['network'] = $downint;
					$rule['descr'] = "m_P2P {$p2pclient[0]} inbound";
				}


				$rule['destination']['port'] = $p2pclient[2]."-".$p2pclient[3];
				if($p2pclient[1] != '')
					$rule['protocol'] = $p2pclient[1];

				$config['shaper']['rule'][] = $rule;
			}
		}

		/* create qP2PUp */
		$queue = array();
		$queue['name'] = "qP2PUp";
                $queue['attachtoqueue'] = "{$upq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 0;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;

		/* create qP2PDown */
		$queue = array();
		$queue['name'] = "qP2PDown";
                $queue['attachtoqueue'] = "{$downq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 0;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
	}	
	</stepsubmitphpaction>
</step>
<step>
        <id>5</id>
        <title>pfSense Traffic Shaper Wizard</title>
	<disableallfieldsbydefault>true</disableallfieldsbydefault>
        <description>Network Games</description>
        <fields>
                <field>
                        <name>Enable</name>
                        <type>checkbox</type>
                        <typehint>Prioritize network gaming traffic</typehint>
                        <description>This will raise the priority of gaming traffic to higher than most traffic.</description>
			<enablefields>BattleNET,Battlefield2,CallOfDuty,Counterstrike,DeltaForce,DOOM3,EmpireEarth,Everquest,Everquest2,FarCry,GunZOnline,HalfLife,HalfLife2,Halo2,Lineage2,PlanetSide,QuakeIII,TigerWoods2004PS2,UnrealTournament,WolfensteinEnemyTerritory,WorldOfWarcraft</enablefields>
			<donotdisable>true</donotdisable>
			<bindstofield>ezshaper->step5->enable</bindstofield>
                </field>
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
                <field>
                        <name>Enable/Disable specific games</name>
                        <type>listtopic</type>
                </field>		
                <field>
                        <name>BattleNET</name>
                        <type>checkbox</type>
			<typehint>Battle.net - Virtually every game from Blizzard publishing should match this.  This includes the following game series: Starcraft, Diablo, Warcraft.  Guild Wars also uses this port.</typehint>
			<bindstofield>ezshaper->step5->battlenet</bindstofield>
                </field>
                <field>
                        <name>Battlefield2</name>
                        <type>checkbox</type>
			<typehint>Battlefield 2 - this game uses a LARGE port range, be aware that you may need to manually rearrange the resulting rules to correctly prioritize other traffic.</typehint>
			<bindstofield>ezshaper->step5->battlefield2</bindstofield>
                </field>
                <field>
                        <name>CallOfDuty</name>
                        <type>checkbox</type>
			<typehint>Call Of Duty (United Offensive)</typehint>
			<bindstofield>ezshaper->step5->callofduty</bindstofield>
                </field>
                <field>
                        <name>Counterstrike</name>
                        <type>checkbox</type>
			<typehint>Counterstrike.   The ultimate 1st person shooter.</typehint>
			<bindstofield>ezshaper->step5->counterstrike</bindstofield>
                </field>
                <field>
                        <name>DeltaForce</name>
                        <type>checkbox</type>
			<typehint>Delta Force</typehint>
			<bindstofield>ezshaper->step5->deltaforce</bindstofield>
                </field>
                <field>
                        <name>DOOM3</name>
                        <type>checkbox</type>
			<typehint>DOOM3</typehint>
			<bindstofield>ezshaper->step5->doom3</bindstofield>
                </field>
                <field>
                        <name>EmpireEarth</name>
                        <type>checkbox</type>
			<typehint>Empire Earth</typehint>
			<bindstofield>ezshaper->step5->empireearth</bindstofield>
                </field>
                <field>
                        <name>Everquest</name>
                        <type>checkbox</type>
			<typehint>Everquest - this game uses a LARGE port range, be aware that you may need to manually rearrange the resulting rules to correctly prioritize other traffic.</typehint>
			<bindstofield>ezshaper->step5->everquest</bindstofield>
                </field>
                <field>
			<name>Everquest2</name>
			<type>checkbox</type>
			<typehint>Everquest II</typehint>
			<bindstofield>ezshaper->step5->everquest2</bindstofield>
		</field>
                <field>
                        <name>GunZOnline</name>
                        <type>checkbox</type>
			<typehint>GunZ Online</typehint>
			<bindstofield>ezshaper->step5->gunzonline</bindstofield>
                </field>
                <field>
                        <name>FarCry</name>
                        <type>checkbox</type>
			<typehint>Far Cry</typehint>
			<bindstofield>ezshaper->step5->farcry</bindstofield>
                </field>
                <field>
                        <name>HalfLife</name>
                        <type>checkbox</type>
			<typehint>HalfLife</typehint>
			<bindstofield>ezshaper->step5->halflife</bindstofield>
                </field>
                <field>
                        <name>HalfLife2</name>
                        <type>checkbox</type>
			<typehint>HalfLife 2</typehint>
			<bindstofield>ezshaper->step5->halflife2</bindstofield>
                </field>
                <field>
                        <name>Halo2</name>
                        <type>checkbox</type>
			<typehint>Halo2 via Xbox live</typehint>
			<bindstofield>ezshaper->step5->halo2xbox</bindstofield>
                </field>
                <field>
                        <name>Lineage2</name>
                        <type>checkbox</type>
			<typehint>Lineage II</typehint>
			<bindstofield>ezshaper->step5->lineage2</bindstofield>
                </field>
                <field>
                        <name>PlanetSide</name>
                        <type>checkbox</type>
			<typehint>PlanetSide</typehint>
			<bindstofield>ezshaper->step5->planetside</bindstofield>
                </field>
                <field>
                        <name>QuakeIII</name>
                        <type>checkbox</type>
			<typehint>Quake III</typehint>
			<bindstofield>ezshaper->step5->quakeiii</bindstofield>
                </field>
                <field>
                        <name>TigerWoods2004PS2</name>
                        <type>checkbox</type>
			<typehint>Tiger Woods 2004 for PS2</typehint>
			<bindstofield>ezshaper->step5->tigerwoods2004ps2</bindstofield>
                </field>
                <field>
                        <name>UnrealTournament</name>
                        <type>checkbox</type>
			<typehint>Unreal Tournament</typehint>
			<bindstofield>ezshaper->step5->unrealtournament</bindstofield>
                </field>
                <field>
                        <name>WolfensteinEnemyTerritory</name>
                        <type>checkbox</type>
			<typehint>Wolfenstein Enemy Territory</typehint>
			<bindstofield>ezshaper->step5->wolfet</bindstofield>
                </field>
                <field>
                        <name>WorldOfWarcraft</name>
                        <type>checkbox</type>
			<typehint>World of Warcraft</typehint>
			<bindstofield>ezshaper->step5->wow</bindstofield>
                </field>
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
        </fields>
	<stepsubmitphpaction>
	/* XXX - billm - needs to actually honor what the user selects still */
	if ( $_POST['enable'] ) {
		$downq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['inside_int']);
		$upq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['outside_int']);
		$downint = strtolower($config['ezshaper']['step2']['inside_int']);
		$upint = strtolower($config['ezshaper']['step2']['outside_int']);

		/* create qGamesUp queue */
		$queue = array();
		$queue['name'] = "qGamesUp";
                $queue['attachtoqueue'] = "{$upq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 5;
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
	    
		/* create qGamesDown queue */
		$queue = array();
		$queue['name'] = "qGamesDown";
                $queue['attachtoqueue'] = "{$downq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 5;
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;

		$gamesplist = array();

		if($_POST['battlefield2'] != "") {
		    /* Battlefield 2 */
		    $gamesplist[] = array('BF2-1500-4999', 'udp', '1500', '4999', 'both');
		    $gamesplist[] = array('BF2-4711', 'tcp', '4711', '4711', 'both');
		    $gamesplist[] = array('BF2-16567', 'udp', '16567', '16567', 'both');
		    $gamesplist[] = array('BF2-27900', 'udp', '27900', '27900', 'both');
		    $gamesplist[] = array('BF2-28910', 'tcp', '28910', '28910', 'both');
		    $gamesplist[] = array('BF2-29900-29901-UDP', 'udp', '29900', '29901', 'both');
		    $gamesplist[] = array('BF2-29900-29901-TCP', 'tcp', '29900', '29901', 'both');
		    $gamesplist[] = array('BF2-27900', 'udp', '27900', '27900', 'both');
		    $gamesplist[] = array('BF2-55123-55125', 'udp', '55123', '55125', 'both');
		}

		if($_POST['counterstrike'] != "") {
		    /* counter strike */
		    $gamesplist[] = array('Titan', 'udp', '6003', '6003', 'both');
		    $gamesplist[] = array('Authentication', 'udp', '7002', '7002', 'both');
		    $gamesplist[] = array('Client', 'udp', '6003', '6003', 'both');
		    $gamesplist[] = array('Masterserver', 'udp', '27010', '27010', 'both');
		    $gamesplist[] = array('Mod-Server', 'udp', '27011', '27011', 'both');
		    $gamesplist[] = array('Chat', 'udp', '27012', '27012', 'both');
		    $gamesplist[] = array('HL-Serverport ', 'udp', '27015', '27015', 'both');
		}

		if($_POST['deltaforce'] != "") {
		    /* delta force */
		    $gamesplist[] = array('Delta1', 'udp', '17478', '17488', 'both');
		}

		if($_POST['quakeiii'] != "") {
		    /* quake3 */
		    $gamesplist[] = array('quakeiii', 'udp', '27910', '27919', 'both');
		}

		if($_POST['tigerwoods2004ps2'] != "") {
		    /* tiger woods 2004 ps2 */
		    $gamesplist[] = array('Outbound2Player', 'udp', '3658', '3658', 'both');
		    $gamesplist[] = array('Outbound2Player2', 'udp', '6000', '6000', 'both');	    
		    $gamesplist[] = array('Outbound2EA', 'tcp', '10300', '10301', 'both');
		}

		if($_POST['callofduty'] != "") {
		    $gamesplist[] = array('CallOfDuty1', 'tcp', '28960', '28960', 'both');
		    $gamesplist[] = array('CallOfDuty2', 'udp', '28960', '28960', 'both');
		}

		if($_POST['planetside'] != "") {
		    /* PlanetSide */
		    $gamesplist[] = array('PlanetSide', 'tcp', '7000', '7000', 'both');
		    $gamesplist[] = array('PlanetSide', 'tcp', '7080', '7080', 'both');
		    $gamesplist[] = array('PlanetSide2', 'udp', '3016', '3021', 'both');
		    $gamesplist[] = array('PlanetSide2', 'udp', '45000', '45010', 'both');
		    $gamesplist[] = array('PlanetSide2', 'udp', '30000', '30500', 'both');
		}

		if($_POST['halo2'] != "") {
		    /* Halo2 + XBOX Live */
		    $gamesplist[] = array('Halo2-1', 'udp', '88', '88', 'both');
		    $gamesplist[] = array('Halo2-2', 'udp', '3074', '3074', 'both');
		    $gamesplist[] = array('Halo2-3', 'tcp', '3074', '3074', 'both');
		}

		if($_POST['unrealtournament'] != "") {
		    /* Unreal Tournament */
		    $gamesplist[] = array('ur1', 'udp', '7777', '7787', 'both');
		    $gamesplist[] = array('ur2', 'tcp', '7777', '7787', 'both');
		}

		if($_POST['doom3'] != "") {
		    /* doom3 */
		    $gamesplist[] = array('DOOM3-1', 'udp', '27650', '27650', 'both');
		    $gamesplist[] = array('DOOM3-2', 'udp', '27666', '27666', 'both');
		}

		if($_POST['empireearth'] != "") {
		    /* empire earth */
		    $gamesplist[] = array('EmpireEarth-1', 'tcp', '33335', '33336', 'both');
		    $gamesplist[] = array('EmpireEarth-2', 'udp', '33334', '33334', 'both');
		}

		if($_POST['everquest'] != "") {
		    /* everquest */
		    $gamesplist[] = array('Everquest-1', 'tcp', '1024', '6000', 'both');
		    $gamesplist[] = array('Everquest-2', 'tcp', '7000', '7000', 'both');
		    $gamesplist[] = array('Everquest-3', 'udp', '1024', '6000', 'both');
		    $gamesplist[] = array('Everquest-4', 'udp', '7000', '7000', 'both');
		}

		if($_POST['everquest2'] != "") {
		    /* everquest2 */
		    $gamesplist[] = array('Everquest2-1', 'tcp', '7000', '7000', 'both');
		    $gamesplist[] = array('Everquest2-2', 'udp', '3016', '3021', 'both');
		    $gamesplist[] = array('Everquest2-3', 'udp', '9100', '9100', 'both');
		    $gamesplist[] = array('Everquest2-4', 'udp', '9700', '9703', 'both');
		    $gamesplist[] = array('Everquest2-5', 'udp', '32800', '33000', 'both');
 		}

		if($_POST['farcry'] != "") {
		    /* far cry */
		    $gamesplist[] = array('FarCry-1', 'tcp', '49001', '49002', 'both');
		    $gamesplist[] = array('FarCry-2', 'udp', '49001', '49002', 'both');
		}

		if($_POST['halflife2'] != "") {
		    /* halflife 2 */
		    $gamesplist[] = array('HL2-1', 'tcp', '27020', '27050', 'both');
		    $gamesplist[] = array('HL2-2', 'udp', '1200', '1200', 'both');
		    $gamesplist[] = array('HL2-3', 'udp', '27000', '27015', 'both');
		}

		if($_POST['halflife'] != "") {
		    /* halflife */
		    $gamesplist[] = array('HL-1', 'tcp', '27015', '27015', 'both');
		    $gamesplist[] = array('HL-2', 'udp', '27650', '27650', 'both');
		    $gamesplist[] = array('HL-3', 'udp', '27666', '27666', 'both');
		}

		if($_POST['wolfet'] != "") {
		    /* wolfenstein enemy territory */
		    $gamesplist[] = array('WolfET-1', 'tcp', '27960', '27960', 'both');
		}

		if($_POST['lineage2'] != "") {
		    /* Lineage II */
		    $gamesplist[] = array('Lineage2-2009', 'tcp', '2009', '2009', 'both');
		    $gamesplist[] = array('Lineage2-2106', 'tcp', '2106', '2106', 'both');
		    $gamesplist[] = array('Lineage2-7777', 'tcp', '7777', '7777', 'both');
		}

		if($_POST['battlenet'] != "") {
		    /* Blizzard Publishing games */
		    $gamesplist[] = array('Battle.NET', 'tcp', '6112', '6119', 'both');
		}
		if($_POST['worldofwarcraft'] != "") {
		    /* World of WarCract */
		    if ($_POST['battlenet'] == "") {
			/* Add battle.net only if WoW is selected and battle.net isn't */
		        $gamesplist[] = array('Battle.NET', 'tcp', '6112', '6119', 'both');
		    }
		    $gamesplist[] = array('WoW', 'tcp', '3724', '3724', 'both');
		}
		if($_POST['gunzonline'] != "") {
		    /* GunZ Online */
		    $gamesplist[] = array('GunZOnline', 'udp', '7700', '7700', 'both');
		}

		/* XXX: add some more games before this line!! */
    
		/* Set up/down games as higher weight */
		/* loop through p2plist[] */
		foreach ($gamesplist as $Gameclient) {
		    foreach (array('source', 'destination') as $srcdest) {
			    $rule = array();
			    $config['shaper']['itemsshaped']++;
			    if ($srcdest == 'source') {
				    $destsrc = 'destination';
				    $rule['inqueue'] = 'qGamesDown';
				    $rule['outqueue'] = 'qGamesUp';
				    $rule['in-interface'] = $downint;
				    $rule['out-interface'] = $upint;
				    $rule['source']['network'] = $downint;
				    $rule['destination']['any'] = TRUE;
				    $rule['descr'] = "m_Game {$Gameclient[0]} outbound";
			    } else {
				    $destsrc = 'source';
				    $rule['inqueue'] = 'qGamesUp';
				    $rule['outqueue'] = 'qGamesDown';
				    $rule['in-interface'] = $upint;
				    $rule['out-interface'] = $downint;
				    $rule['source']['any'] = TRUE;
				    $rule['destination']['network'] = $downint;
				    $rule['descr'] = "m_Game {$Gameclient[0]} inbound";
			    }
    
			    $rule['destination']['port'] = $Gameclient[2]."-".$Gameclient[3];

			    if($Gameclient[1] != '')
				    $rule['protocol'] = $Gameclient[1];
    
			    $config['shaper']['rule'][] = $rule;
		    }
		}
	}
	</stepsubmitphpaction>
</step>
<step>
        <id>6</id>
        <title>pfSense Traffic Shaper Wizard</title>
	<disableallfieldsbydefault>true</disableallfieldsbydefault>
        <description>Raise or lower other Applications</description>
        <fields>
                <field>
                        <name>Enable</name>
                        <type>checkbox</type>
                        <typehint>Other networking protocols</typehint>
                        <description>This will help raise or lower the priority of other protocols higher than most traffic.</description>
			<enablefields>AIM,AppleRemoteDesktop,DNS,HTTP,ICMP,ICQ,IMAP,IPSEC,IRC,LotusNotes,MSN,MSRDP,MySqlServer,PCAnywhere,POP3,PPTP,RTSP,SMB,SMTP,SNMP,StreamingMP3,TeamSpeak,VNC,NNTP,CVSUP</enablefields>
			<donotdisable>true</donotdisable>
			<bindstofield>ezshaper->step6->enable</bindstofield>
                </field>
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
                <field>
                        <name>Remote Service / Terminal emulation</name>
			<type>listtopic</type>
                </field>		
                <field>
                        <name>MSRDP</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->msrdp</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Microsoft Remote Desktop Protocol</typehint>
                </field>
                <field>
                        <name>VNC</name>
			<bindstofield>ezshaper->step6->vnc</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Virtual Network Computing</typehint>
                </field>
                <field>
                        <name>AppleRemoteDesktop</name>
			<bindstofield>ezshaper->step6->appleremotedesktop</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Apple Remote Desktop</typehint>
                </field>
                <field>
                        <name>PCAnywhere</name>
			<bindstofield>ezshaper->step6->pcanywhere</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Symantec PC Anywhere</typehint>
                </field>
                <field>
                        <name>Messengers</name>
			<type>listtopic</type>
                </field>
                <field>
                        <name>IRC</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->irc</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Internet Relay Chat</typehint>
                </field>
                <field>
                        <name>ICQ</name>
			<bindstofield>ezshaper->step6->icq</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>ICQ</typehint>
                </field>
                <field>
                        <name>AIM</name>
			<bindstofield>ezshaper->step6->aolinstantmessenger</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>AOL Instant Messenger</typehint>
                </field>
                <field>
                        <name>MSN</name>
			<bindstofield>ezshaper->step6->msnmessenger</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>MSN Messenger</typehint>
                </field>
                <field>
                <name>Teamspeak</name>
			<bindstofield>ezshaper->step6->teamspeak</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>TeamSpeak</typehint>
                </field>
                <field>
                        <name>VPN</name>
			<type>listtopic</type>
                </field>
                <field>
                        <name>PPTP</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->pptp</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Microsoft Point to Point tunneling protocol</typehint>
                </field>
                <field>
                        <name>IPSEC</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->ipsec</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>IPSEC VPN traffic</typehint>
                </field>
                <field>
                        <name>Multimedia/Streaming</name>
			<type>listtopic</type>
                </field>
                <field>
                        <name>StreamingMP3</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->streamingmp3</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Streaming Media</typehint>
                </field>
                <field>
                        <name>RTSP</name>
			<bindstofield>ezshaper->step6->rtsp</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>RealTime streaming protocol</typehint>
                </field>
                <field>
                        <name>Web</name>
			<type>listtopic</type>
                </field>
                <field>
                        <name>HTTP</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->http</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>HTTP and HTTPS aka Web Traffic</typehint>
                </field>
                <field>
                        <name>Mail</name>
			<type>listtopic</type>
                </field>
                <field>
                        <name>SMTP</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->smtp</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Mail Protocol</typehint>
                </field>
                <field>
                        <name>POP3</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->pop3</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>POP3 Protocol</typehint>
                </field>
                <field>
                        <name>IMAP</name>
			<bindstofield>ezshaper->step6->imap</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>IMAP Protocol</typehint>
                </field>
                <field>
                        <name>LotusNotes</name>
			<bindstofield>ezshaper->step6->lotusnotes</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Lotus Notes</typehint>
                </field>
                <field>
                        <name>Miscellaneous</name>
			<type>listtopic</type>
                </field>
                               <field>
                        <name>DNS</name>
			<type>select</type>
			<bindstofield>ezshaper->step6->dns</bindstofield>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Domain Name Services</typehint>
                </field>
                <field>
                        <name>ICMP</name>
			<bindstofield>ezshaper->step6->icmp</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>ICMP Protocol</typehint>
                </field>
                <field>
                        <name>SMB</name>
			<bindstofield>ezshaper->step6->smb</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Microsoft SMB Protocol and friends</typehint>
                </field>
                <field>
                        <name>SNMP</name>
			<bindstofield>ezshaper->step6->snmp</bindstofield>
			<type>select</type>
			<options>
				<option>
					<name>Higher priority</name>
					<value>H</value>
				</option>
				<option>
					<name>Default priority</name>
					<value></value>
				</option>
				<option>
					<name>Lower priority</name>
					<value>L</value>
				</option>
			</options>
			<typehint>Simple Network Management Protocol</typehint>
                </field> 
                <field>
                        <name>MySQLServer</name>
						<bindstofield>ezshaper->step6->mysqlserver</bindstofield>
						<type>select</type>
						<options>
							<option>
								<name>Higher priority</name>
								<value>H</value>
							</option>
							<option>
								<name>Default priority</name>
								<value></value>
							</option>
							<option>
								<name>Lower priority</name>
								<value>L</value>
							</option>
						</options>
						<typehint>MySQL Server</typehint>
                </field>
                <field>
						<name>NNTP</name>
						<bindstofield>ezshaper->step6->nntp</bindstofield>
						<type>select</type>
						<options>
							<option>
								<name>Higher priority</name>
								<value>H</value>
							</option>
							<option>
								<name>Default priority</name>
								<value></value>
							</option>
							<option>
								<name>Lower priority</name>
								<value>L</value>
							</option>
						</options>
						<typehint>Internet News</typehint>
                </field>
                <field>
						<name>CVSUP</name>
						<bindstofield>ezshaper->step6->cvsup</bindstofield>
						<type>select</type>
						<options>
							<option>
								<name>Higher priority</name>
								<value>H</value>
							</option>
							<option>
								<name>Default priority</name>
								<value></value>
							</option>
							<option>
								<name>Lower priority</name>
								<value>L</value>
							</option>
						</options>
						<typehint>CVSUP</typehint>
                </field>					
                <field>
                        <name>Next</name>
                        <type>submit</type>
                </field>
        </fields>
	<stepsubmitphpaction>
	if ( $_POST['enable'] ) {
		$downq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['inside_int']);
		$upq = "q" . convert_friendly_interface_to_friendly_descr($config['ezshaper']['step2']['outside_int']);
		$downint = strtolower($config['ezshaper']['step2']['inside_int']);
		$upint = strtolower($config['ezshaper']['step2']['outside_int']);
		/* create qOthersUp queue */
		$queue = array();
		$queue['name'] = "qOthersUpH";
                $queue['attachtoqueue'] = "{$upq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 6;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
	    
		/* create qOthersDown queue */
		$queue = array();
		$queue['name'] = "qOthersDownH";
                $queue['attachtoqueue'] = "{$downq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 6;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
                

		/* create qOthersUp queue */
		$queue = array();
		$queue['name'] = "qOthersUpL";
                $queue['attachtoqueue'] = "{$upq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 2;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
	    
		/* create qOthersDown queue */
		$queue = array();
		$queue['name'] = "qOthersDownL";
                $queue['attachtoqueue'] = "{$downq}Root";
		$queue['associatedrule'] = 0;
		$queue['priority'] = 2;
		$queue['red'] = "on";
		$queue['ecn'] = "on";
		if ($config['shaper']['schedulertype'] == "hfsc") {
			$queue['realtime'] = "on";
			$queue['realtime3'] = "1Kb";
			$queue['bandwidth'] = 1;
			$queue['bandwidthtype'] = '%';
			$queue['qlimit'] = 500;
		} elseif ($config['shaper']['schedulertype'] == "cbq") {
			$queue['borrow'] = "on";
                        $queue['bandwidth'] = 6;
                        $queue['bandwidthtype'] = 'Kb';
                }
		$config['shaper']['queue'][] = $queue;
		
		$othersplist = array();
		
		/* Unlike other areas we are posting the queue H or L or BLANK */
		
		if($_POST['msrdp'] != "") {
		    /* MSRDP */
		    $othersplist[] = array('MSRDP', 'tcp', '3389', '3389', 'both', $_POST['msrdp']);
		}
		
		if($_POST['pptp'] != "") {
		    /* PPTP */
		    $othersplist[] = array('PPTP', 'tcp', '1723', '1723', 'both', $_POST['pptp']);
		    $othersplist[] = array('PPTPGRE', 'gre', '', '', 'both', $_POST['pptp']);
                }

		if($_POST['ipsec'] != "") {
		    /* IPSEC */
		    $othersplist[] = array('IPSEC', 'udp', '500', '500', 'both', $_POST['ipsec']);
		    $othersplist[] = array('IPSEC', 'ah', '', '', 'both', $_POST['ipsec']);
		    $othersplist[] = array('IPSEC', 'esp', '', '', 'both', $_POST['ipsec']);
		}
		
		if($_POST['streamingmp3'] != "") {
		    /* streaming mp3 media aka shoutcast */
		    $othersplist[] = array('STREAMINGMP3', 'tcp', '8000', '8100', 'both', $_POST['streamingmp3']);
		}
		
		if($_POST['irc'] != "") {
		    /* internet relay chat */
		    $othersplist[] = array('IRC', 'tcp', '6667', '6670', 'both', $_POST['irc']);
		}

		if($_POST['dns'] != "") {
		    /* domain name system */
		    $othersplist[] = array('DNS1', 'tcp', '53', '53', 'both', $_POST['dns']);
		    $othersplist[] = array('DNS2', 'udp', '53', '53', 'both', $_POST['dns']);
		}
		
		if($_POST['http'] != "") {
		    /* HTTP aka Web Traffic */
		    $othersplist[] = array('HTTP', 'tcp', '80', '80', 'both', $_POST['http']);
		    $othersplist[] = array('HTTPS', 'tcp', '443', '443', 'both', $_POST['http']);
		}
		
		if($_POST['smtp'] != "") {
		    /* Secure shell traffic */
		    $othersplist[] = array('SMTP', 'tcp', '25', '25', 'both', $_POST['smtp']);
		}

		if($_POST['pop3'] != "") {
		    /* Post Office Protocol - POP3 */
		    $othersplist[] = array('POP3', 'tcp', '110', '110', 'both', $_POST['pop3']);
		}
		
		if($_POST['icmp'] != "") {
		    /* ICMP */
		    $othersplist[] = array('ICMP', 'icmp', '', '', 'both', $_POST['icmp']);
		}		

		if($_POST['imap'] != "") {
		    /* IMAP */
		    $othersplist[] = array('IMAP', 'tcp', '143', '143', 'both', $_POST['imap']);
		}

		if($_POST['smb'] != "") {
		    /* Microsoft SMB and friends */
		    $othersplist[] = array('SMB1', 'tcp', '445', '445', 'both', $_POST['smb']);
		    $othersplist[] = array('SMB2', 'tcp', '137-139', '137-139', 'both', $_POST['smb']);

		if($_POST['rtsp'] != "") {
		    /* realtime streaming protocol */
		    $othersplist[] = array('RTSP1', 'tcp', '554', '554', 'both', $_POST['rtsp']);
		}		}

		if($_POST['snmp'] != "") {
		    /* Simple network management protocol */
		    $othersplist[] = array('SNMP', 'tcp', '161', '161', 'both', $_POST['snmp']);
		    $othersplist[] = array('SNMP2', 'udp', '161', '161', 'both', $_POST['snmp']);
		}

		if($_POST['vnc'] != "") {
		    /* virtual network control */
		    $othersplist[] = array('VNC', 'tcp', '5900', '5930', 'both', $_POST['vnc']);
		}		

		if($_POST['appleremotedesktop'] != "") {
		    /* apple remote desktop */
		    $othersplist[] = array('AppleRemoteDesktop1', 'tcp', '3283', '3283', 'both', $_POST['appleremotedesktop']);
		    $othersplist[] = array('AppleRemoteDesktop2', 'tcp', '5900', '5900', 'both', $_POST['appleremotedesktop']);
		    $othersplist[] = array('AppleRemoteDesktop3', 'udp', '3283', '3283', 'both', $_POST['appleremotedesktop']);
		    $othersplist[] = array('AppleRemoteDesktop4', 'udp', '5900', '5900', 'both', $_POST['appleremotedesktop']);
		}		

		if($_POST['icq'] != "") {
		    /* icq */
		    $othersplist[] = array('ICQ1', 'tcp', '5190', '5190', 'both', $_POST['icq']);
		    $othersplist[] = array('ICQ2', 'udp', '5190', '5190', 'both', $_POST['icq']);
		}		
		
		if($_POST['lotusnotes'] != "") {
		    /* lotus notes */
		    $othersplist[] = array('LotusNotes1', 'tcp', '1352', '1352', 'both', $_POST['lotusnotes']);
		    $othersplist[] = array('LotusNotes2', 'udp', '1352', '1352', 'both', $_POST['lotusnotes']);
		}		
		if($_POST['aolinstantmessenger'] != "") {
		    /* AIM */
		    $othersplist[] = array('AIM', 'tcp', '5190', '5190', 'both', $_POST['aolinstantmessenger']);
		}

		if($_POST['msnmessenger'] != "") {
		    /* msn messenger */
		    $othersplist[] = array('MSN1', 'tcp', '1863', '1863', 'both', $_POST['msnmessenger']);
		    $othersplist[] = array('MSN2', 'tcp', '6891', '6900', 'both', $_POST['msnmessenger']);
		    $othersplist[] = array('MSN3', 'tcp', '6901', '6901', 'both', $_POST['msnmessenger']);
		    $othersplist[] = array('MSN4', 'udp', '6901', '6901', 'both', $_POST['msnmessenger']);
		}		

		if($_POST['mysqlserver'] != "") {
		    /* mysql server */
		    $othersplist[] = array('MySQL1', 'tcp', '3306', '3306', 'both', $_POST['mysqlserver']);
		}
		
		if($_POST['nntp'] != "") {
		    /* nntp */
		    $othersplist[] = array('NNTP1', 'tcp', '119', '119', 'both', $_POST['mysqlserver']);
			$othersplist[] = array('NNTP2', 'udp', '119', '119', 'both', $_POST['mysqlserver']);
		}			

		if($_POST['pcanwhere'] != "") {
		    /* symantec pc anywhere */
		    $othersplist[] = array('pcany1', 'tcp', '5631', '5631', 'both', $_POST['pcanywhere']);
		    $othersplist[] = array('pcany2', 'udp', '5632', '5632', 'both', $_POST['pcanywhere']);
		    }		

		if($_POST['teamspeak'] != "") {
		    /* teamspeak  */
		    $othersplist[] = array('teamspeak1', 'tcp', '14534', '14534', 'both', $_POST['teamspeak']);
		    $othersplist[] = array('teamspeak2', 'tcp', '51234', '51234', 'both', $_POST['teamspeak']);
		    $othersplist[] = array('teamspeak3', 'udp', '8767', '8768', 'both', $_POST['teamspeak']);
		}		

		if($_POST['cvsup'] != "") {
		    /* teamspeak  */
		    $othersplist[] = array('cvs', 'tcp', '5999', '5999', 'both', $_POST['teamspeak']);
		}	

		/* XXX: add some more protocols here! */
    
		/* Set up/down protocols as higher weight */
		/* loop through othersplist[] */
		foreach ($othersplist as $otherclient) {
		    foreach (array('source', 'destination') as $srcdest) {
			    $rule = array();
			    $config['shaper']['itemsshaped']++;
			    if ($srcdest == 'source') {
				    $destsrc = 'destination';
				    $rule['inqueue'] = 'qOthersDown' . $otherclient[5]; /* posted value H or L */
				    $rule['outqueue'] = 'qOthersUp' . $otherclient[5]; /* posted value H or L */
				    $rule['in-interface'] = $downint;
				    $rule['out-interface'] = $upint;
				    $rule['source']['network'] = $downint;
				    $rule['destination']['any'] = TRUE;
				    $rule['descr'] = "m_Other {$otherclient[0]} outbound";
			    } else {
				    $destsrc = 'source';
				    $rule['inqueue'] = 'qOthersUp' . $otherclient[5]; /* posted value H or L */
				    $rule['outqueue'] = 'qOthersDown' . $otherclient[5]; /* posted value H or L */
				    $rule['in-interface'] = $upint;
				    $rule['out-interface'] = $downint;
				    $rule['source']['any'] = TRUE;
				    $rule['destination']['network'] = $downint;
				    $rule['descr'] = "m_Other {$otherclient[0]} inbound";
			    }
				
				if($otherclient[2] or $otherclient[3]) {
				    $rule['destination']['port'] = $otherclient[2]."-".$otherclient[3];
					if($otherclient[1] != '')
				    $rule['protocol'] = $otherclient[1];
				}
    
			    $config['shaper']['rule'][] = $rule;
		    }
		}
    }		
	</stepsubmitphpaction>
</step>
<step>
        <id>7</id>
        <title>pfSense Traffic Shaper Wizard</title>
        <field>
		<name>Reload profile notice</name>
		<type>listtopic</type>
        </field>	
        <description>
	    After pressing Finish the system will load the new profile.&lt;br/&gt;
	    Please note that this may take a moment.&lt;br/&gt;
	    Also note that the traffic shaper is stateful meaning that only new connections will be shaped.&lt;br/&gt;
	    If this is an issue please reset the state table after loading the profile.&lt;br/&gt;
	</description>
	<fields>
                <field>
                        <name>Finish</name>
                        <type>submit</type>
                </field>
	</fields>
	<stepbeforeformdisplay>
		if($config['shaper']['itemsshaped'] == "0") {
		    /*    no shaper items have been selected 
		     *    wipe previous
		     */
		    unset($config['shaper']['queue']);
		    unset($config['shaper']['rule']);
		    unset($config['shaper']);
		    $config['shaper']['enable'] = FALSE;
		    $message = "No items have been selected to shape.  Exiting traffic shaper wizard.";
		    write_config("No shaper items picked, unsetting shaper configuration");
		    header("Location: /wizard.php?xml=traffic_shaper_wizard.xml&amp;stepid=7&amp;message={$message}");
		    exit;
		}	    
	</stepbeforeformdisplay>
	<stepsubmitphpaction>
		/* Sort rules by queue priority */
		 sort_rule_by_queue_priority(); 

		/* install default p2p catch all rule if user has enabled option (MUST BE LAST!) */
		if($config['ezshaper']['step4']['p2pcatchall'] == "on") {
			$othersplist = array();
		    $othersplist[] = array('p2pCatchAll', 'tcp', '', '', 'both', '');
		    $othersplist[] = array('p2pCatchAll2', 'udp', '', '', 'both', '');
		} else {
			$othersplist = array();
		}

		/* Set up/down protocols as p2p weight */
		/* loop through othersplist[] */
		foreach ($othersplist as $otherclient) {
		    foreach (array('source', 'destination') as $srcdest) {
			    $rule = array();
			    $config['shaper']['itemsshaped']++;
			    if ($srcdest == 'source') {
				    $destsrc = 'destination';
				    $rule['inqueue'] = 'qP2PDown' . $otherclient[5]; /* posted value H or L */
				    $rule['outqueue'] = 'qP2PUp' . $otherclient[5]; /* posted value H or L */
				    $rule['in-interface'] = $downint;
				    $rule['out-interface'] = $upint;
				    $rule['source']['network'] = $downint;
				    $rule['destination']['any'] = TRUE;
				    $rule['descr'] = "p2pCatchAll outbound";
			    } else {
				    $destsrc = 'source';
				    $rule['inqueue'] = 'qP2PUp' . $otherclient[5]; /* posted value H or L */
				    $rule['outqueue'] = 'qP2PDown' . $otherclient[5]; /* posted value H or L */
				    $rule['in-interface'] = $upint;
				    $rule['out-interface'] = $downint;
				    $rule['source']['any'] = TRUE;
				    $rule['destination']['network'] = $downint;
				    $rule['descr'] = "p2pCatchAll inbound";
			    }
				
				if($otherclient[2] or $otherclient[3]) {
				    $rule['destination']['port'] = $otherclient[2]."-".$otherclient[3];
					if($otherclient[1] != '')
				    $rule['protocol'] = $otherclient[1];
				}
    
				if($rule['inqueue'] != "") 
					$config['shaper']['rule'][] = $rule;
		    }
		}

		/* Enable shaper */
		$config['shaper']['enable'] = TRUE;

		/* Prepare for next ezshaper wizard run */
		unset($config['shaper']['itemsshaped']);

		/* Create new rules */
		filter_configure();

		/* And we're no longer dirty! */
		unlink_if_exists($d_shaperconfdirty_path);

		update_filter_reload_status("Initializing");

		/* Head over and check out the groovy queue stats */
		header("Location: status_filter_reload.php");
	</stepsubmitphpaction>
</step>
<step>
	<id>8</id>
        <title>pfSense Traffic Shaper Wizard</title>
	<fields>
		<field>
			<name>Finish</name>
			<type>submit</type>
		</field>
	</fields>
	<stepsubmitphpaction>
		header("Location: status_filter_reload.php");
	</stepsubmitphpaction>
</step>
</pfsensewizard>
